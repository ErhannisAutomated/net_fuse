<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NetFuse</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; color: #333; }
.header { background: #2c3e50; color: #fff; padding: 12px 20px; display: flex; align-items: center; gap: 12px; }
.header h1 { font-size: 1.2em; font-weight: 600; }
.header .status { font-size: 0.8em; opacity: 0.7; margin-left: auto; }
.breadcrumb { background: #fff; padding: 10px 20px; border-bottom: 1px solid #ddd; display: flex; flex-wrap: wrap; align-items: center; gap: 4px; }
.breadcrumb a { color: #2980b9; text-decoration: none; }
.breadcrumb a:hover { text-decoration: underline; }
.breadcrumb span { color: #999; }
.toolbar { padding: 10px 20px; display: flex; gap: 8px; flex-wrap: wrap; }
.toolbar button, .toolbar label { background: #3498db; color: #fff; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
.toolbar button:hover, .toolbar label:hover { background: #2980b9; }
.toolbar label { display: inline-flex; align-items: center; }
.toolbar input[type=file] { display: none; }
.container { padding: 0 20px 20px; }
table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 4px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
th { background: #ecf0f1; text-align: left; padding: 10px 12px; font-weight: 600; font-size: 0.85em; color: #555; }
td { padding: 10px 12px; border-top: 1px solid #eee; }
tr:hover { background: #f9f9f9; }
td a { color: #2980b9; text-decoration: none; }
td a:hover { text-decoration: underline; }
.icon { margin-right: 6px; }
.size { color: #888; font-size: 0.9em; }
.time { color: #888; font-size: 0.85em; }
.actions button { background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 0.85em; padding: 4px 8px; }
.actions button:hover { text-decoration: underline; }
.modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 100; align-items: center; justify-content: center; }
.modal-overlay.active { display: flex; }
.modal { background: #fff; padding: 24px; border-radius: 8px; min-width: 300px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
.modal h3 { margin-bottom: 12px; }
.modal input[type=text] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 12px; }
.modal .btns { display: flex; gap: 8px; justify-content: flex-end; }
.modal .btns button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
.modal .btns .ok { background: #3498db; color: #fff; }
.modal .btns .cancel { background: #ecf0f1; }
.empty { text-align: center; padding: 40px; color: #999; }
@media (max-width: 600px) {
  .header { padding: 10px; }
  .toolbar { padding: 8px 10px; }
  .container { padding: 0 10px 10px; }
  th, td { padding: 8px 6px; font-size: 0.85em; }
}
</style>
</head>
<body>

<div class="header">
  <h1>NetFuse</h1>
  <span class="status" id="status">Connected</span>
</div>

<div class="breadcrumb" id="breadcrumb"></div>

<div class="toolbar">
  <label>Upload<input type="file" id="fileInput" multiple></label>
  <button onclick="showMkdir()">New Folder</button>
</div>

<div class="container">
  <table>
    <thead><tr><th>Name</th><th>Size</th><th>Modified</th><th></th></tr></thead>
    <tbody id="listing"></tbody>
  </table>
</div>

<div class="modal-overlay" id="mkdirModal">
  <div class="modal">
    <h3>Create Folder</h3>
    <input type="text" id="mkdirName" placeholder="Folder name">
    <div class="btns">
      <button class="cancel" onclick="hideMkdir()">Cancel</button>
      <button class="ok" onclick="doMkdir()">Create</button>
    </div>
  </div>
</div>

<script>
let currentPath = '/';

function formatSize(bytes) {
  if (bytes == null) return '-';
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
  if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
  return (bytes / 1073741824).toFixed(2) + ' GB';
}

function formatTime(secs) {
  if (!secs) return '-';
  return new Date(secs * 1000).toLocaleString();
}

function updateBreadcrumb() {
  const el = document.getElementById('breadcrumb');
  const parts = currentPath.split('/').filter(Boolean);
  let html = '<a href="#" onclick="navigate(\'/\');return false;">/</a>';
  let accum = '/';
  for (const p of parts) {
    accum += p + '/';
    const path = accum;
    html += ' <span>/</span> <a href="#" onclick="navigate(\'' + path.replace(/'/g, "\\'") + '\');return false;">' + escHtml(p) + '</a>';
  }
  el.innerHTML = html;
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

async function navigate(path) {
  currentPath = path;
  updateBreadcrumb();
  await loadListing();
}

async function loadListing() {
  const el = document.getElementById('listing');
  try {
    const resp = await fetch('/api/ls?path=' + encodeURIComponent(currentPath));
    if (!resp.ok) { el.innerHTML = '<tr><td colspan="4" class="empty">Error: ' + resp.status + '</td></tr>'; return; }
    const entries = await resp.json();
    if (entries.length === 0) {
      el.innerHTML = '<tr><td colspan="4" class="empty">Empty directory</td></tr>';
      return;
    }
    entries.sort((a, b) => {
      if (a.kind !== b.kind) return a.kind === 'directory' ? -1 : 1;
      return a.name.localeCompare(b.name);
    });
    let html = '';
    for (const e of entries) {
      const icon = e.kind === 'directory' ? '&#128193;' : '&#128196;';
      const nameHtml = e.kind === 'directory'
        ? '<a href="#" onclick="navigate(\'' + (currentPath + e.name + '/').replace(/'/g, "\\'") + '\');return false;">' + icon + ' ' + escHtml(e.name) + '</a>'
        : '<a href="/api/file?path=' + encodeURIComponent(currentPath + e.name) + '" download>' + icon + ' ' + escHtml(e.name) + '</a>';
      html += '<tr>'
        + '<td>' + nameHtml + '</td>'
        + '<td class="size">' + (e.kind === 'directory' ? '-' : formatSize(e.size)) + '</td>'
        + '<td class="time">' + formatTime(e.mtime_secs) + '</td>'
        + '<td class="actions"><button onclick="doDelete(\'' + (currentPath + e.name).replace(/'/g, "\\'") + '\',\'' + e.kind + '\')">Delete</button></td>'
        + '</tr>';
    }
    el.innerHTML = html;
    document.getElementById('status').textContent = 'Connected';
  } catch (err) {
    el.innerHTML = '<tr><td colspan="4" class="empty">Connection error</td></tr>';
    document.getElementById('status').textContent = 'Disconnected';
  }
}

document.getElementById('fileInput').addEventListener('change', async function() {
  for (const file of this.files) {
    const form = new FormData();
    form.append('file', file);
    await fetch('/api/upload?path=' + encodeURIComponent(currentPath), { method: 'POST', body: form });
  }
  this.value = '';
  await loadListing();
});

function showMkdir() { document.getElementById('mkdirModal').classList.add('active'); document.getElementById('mkdirName').value = ''; document.getElementById('mkdirName').focus(); }
function hideMkdir() { document.getElementById('mkdirModal').classList.remove('active'); }

async function doMkdir() {
  const name = document.getElementById('mkdirName').value.trim();
  if (!name) return;
  hideMkdir();
  await fetch('/api/mkdir?path=' + encodeURIComponent(currentPath + name), { method: 'POST' });
  await loadListing();
}

async function doDelete(path, kind) {
  if (!confirm('Delete "' + path + '"?')) return;
  await fetch('/api/file?path=' + encodeURIComponent(path), { method: 'DELETE' });
  await loadListing();
}

document.getElementById('mkdirName').addEventListener('keydown', function(e) { if (e.key === 'Enter') doMkdir(); if (e.key === 'Escape') hideMkdir(); });

navigate('/');
</script>
</body>
</html>
